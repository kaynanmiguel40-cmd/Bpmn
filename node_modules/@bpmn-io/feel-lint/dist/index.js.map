{"version":3,"file":"index.js","sources":["../lib/shared/syntax.js","../rules/first-item.js","../lib/shared/rules.js","../lib/shared/index.js","../lib/text/util.js","../lib/text/index.js","../lib/editor/index.js"],"sourcesContent":["/**\n * @typedef {import('@lezer/common').Tree} Tree\n * @typedef {import('@codemirror/lint').Diagnostic} LintMessage\n */\n\n/**\n * Create an array of syntax errors in the given tree.\n *\n * @param {Tree} syntaxTree\n * @returns {LintMessage[]} array of syntax errors\n */\nexport default function lintSyntax(syntaxTree) {\n\n  const lintMessages = [];\n\n  syntaxTree.iterate({\n    enter: ref => {\n      const node = ref.node;\n\n      if (!node.type.isError) {\n        return;\n      }\n\n      const parent = node.parent;\n      const next = getNextNode(node);\n\n      const message = {\n        from: node.from,\n        to: node.to,\n        severity: 'error',\n        type: 'Syntax Error'\n      };\n\n      if (node.from !== node.to) {\n        message.message = `Unrecognized token in <${parent.name}>`;\n      } else if (next) {\n        message.message = `Unrecognized token <${next.name}> in <${parent.name}>`;\n        message.to = next.to;\n      } else {\n        const before = parent.enterUnfinishedNodesBefore(node.to);\n        message.message = `Incomplete <${ (before || parent).name }>`;\n      }\n\n      lintMessages.push(message);\n    }\n  });\n\n  return lintMessages;\n}\n\nfunction getNextNode(node) {\n  if (!node) {\n    return null;\n  }\n\n  return node.nextSibling || getNextNode(node.parent);\n}","/**\n * @typedef {object} Context\n * @property {function} report\n * @property {(from: number, to: number) => string} readContent\n * @property {(from: number, to: number, content: string) => void} updateContent\n */\n\nconst RULE_NAME = 'first-item';\n\nexport default {\n  create(/** @type {Context} */ context) {\n    return {\n      enter(node) {\n        if (node.name !== 'FilterExpression') {\n          return;\n        }\n\n        const content = context.readContent(node.from, node.to);\n\n        if (zeroIndexPattern().test(content)) {\n          const {\n            from,\n            to\n          } = node;\n\n          context.report({\n            from,\n            to,\n            message: 'First item is accessed via [1]',\n            severity: 'warning',\n            type: RULE_NAME,\n            actions: [\n              {\n                name: 'fix',\n                apply(_, start = from, end = to) {\n                  context.updateContent(start, end, content.replace(zeroIndexPattern(), '[1]'));\n                }\n              }\n            ]\n          });\n        }\n      }\n    };\n  }\n};\n\nfunction zeroIndexPattern() {\n  return /\\[\\s*0\\s*\\]$/;\n}\n","import firstItem from '../../rules/first-item.js';\n\n/**\n * @typedef {import('@lezer/common').Tree} Tree\n * @typedef {import('@codemirror/lint').Diagnostic} LintMessage\n * @typedef {import('./index').LintAllContext} LintAllContext\n */\n\nconst RULES = [\n  firstItem\n];\n\n/**\n * Create an array of messages reported from rules in the given tree.\n *\n * @param {LintAllContext} context\n * @returns {LintMessage[]} array of syntax errors\n */\nexport function lintRules(context) {\n  const {\n    readContent,\n    syntaxTree,\n    updateContent\n  } = context;\n\n  const lintMessages = [];\n\n  const ruleContext = {\n    readContent,\n    report: message => {\n      lintMessages.push(message);\n    },\n    updateContent\n  };\n\n  const rules = RULES.map(rule => rule.create(ruleContext));\n\n  syntaxTree.iterate({\n    enter: ref => {\n      for (const rule of rules) {\n        rule.enter && rule.enter(ref);\n      }\n    },\n    leave: ref => {\n      for (const rule of rules) {\n        rule.leave && rule.leave(ref);\n      }\n    }\n  });\n\n  return lintMessages;\n}\n","import lintSyntax from './syntax.js';\nimport { lintRules } from './rules.js';\n\n/**\n * @typedef {import('@lezer/common').Tree} Tree\n * @typedef {import('@codemirror/lint').Diagnostic} LintMessage\n */\n\n/**\n * @typedef {object} LintAllContext\n * @property {Tree} syntaxTree\n * @property {(from: number, to: number) => string} readContent\n * @property {(from: number, to: number, content: string) => void} updateContent\n */\n\n/**\n * Generates lint messages for the given context.\n *\n * @param {LintAllContext} context\n * @returns {LintMessage[]} array of all lint messages\n */\nexport default function lintAll(context) {\n\n  const lintMessages = [\n    ...lintSyntax(context.syntaxTree),\n    ...lintRules(context)\n  ];\n\n  return lintMessages;\n}","/**\n * @typedef {object} Variable\n * @property {string} name name or key of the variable\n * @property {string} [info] longer description of the variable content\n * @property {string} [detail] short information about the variable, e.g. type\n * @property {boolean} [isList] whether the variable is a list\n * @property {Array<Variable>} [schema] array of child variables if the variable is a context or list\n * @property {Array<{name: string, type: string}>} [params] function parameters\n */\n\n/**\n * @param { Variable[] } variables\n *\n * @return {Record<string, any>}\n */\nexport function createContext(variables) {\n  return variables.slice().reverse().reduce((context, variable) => {\n    context[variable.name] = () => {};\n\n    return context;\n  }, {});\n}\n","import { parser, trackVariables } from '@bpmn-io/lezer-feel';\nimport lintAll from '../shared/index.js';\nimport { createContext } from './util.js';\n\n/**\n * Create an array of syntax errors for the given expression.\n *\n * @param {String} expression\n * @param { {\n *   dialect?: 'expression' | 'unaryTests',\n *   parserDialect?: string,\n *   builtins?: import(\"./util.js\").Variable[],\n *   variables?: import(\"./util.js\").Variable[],\n * } } [lintOptions]\n *\n * @returns {import(\"../shared\").LintMessage[]} array of syntax errors\n */\nexport function lintExpression(expression, {\n  dialect = 'expression',\n  parserDialect,\n  builtins = [],\n  variables = [],\n} = {}) {\n\n  const context = createContext([ ...builtins, ...variables ]);\n\n  const syntaxTree = parser.configure({\n    top: dialect === 'unaryTests' ? 'UnaryTests' : 'Expression',\n    dialect: parserDialect,\n    contextTracker: trackVariables(context)\n  }).parse(expression);\n\n  const lintMessages = lintAll({\n    syntaxTree,\n    readContent: (from, to) => expression.slice(from, to),\n    updateContent: (from, to, content) => {\n\n      // not implemented\n    }\n  });\n\n  return lintMessages;\n}","import { syntaxTree } from '@codemirror/language';\nimport lintAll from '../shared/index.js';\n\n/**\n * CodeMirror extension that provides linting for FEEL expressions.\n *\n * @returns {import('@codemirror/lint').LintSource} CodeMirror linting source\n */\nexport const cmFeelLinter = () => editorView => {\n\n  // don't lint if the Editor is empty\n  if (editorView.state.doc.length === 0) {\n    return [];\n  }\n\n  const tree = syntaxTree(editorView.state);\n\n  const messages = lintAll({\n    syntaxTree: tree,\n    readContent: (from, to) => editorView.state.sliceDoc(from, to),\n    updateContent: (from, to, content) => editorView.dispatch({\n      changes: { from, to, insert: content }\n    })\n  });\n\n  return messages.map(message => ({\n    ...message,\n    source: message.type\n  }));\n};"],"names":[],"mappings":"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"}